name: Deploy Monitoring

on:
  push:
    paths:
      - k8s/monitoring/**
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: eks-cluster

jobs:
  deploy-app:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4
      # 2. Assume monitoring IAM role
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::ACCOUNT_ID:role/kubernetes-ci-monitoring-role
          aws-region: us-east-1
      # 3. Configure kubectl (EKS API access)
      - name: Update kubeconfig
        run: aws eks update-kubeconfig \
               --name $CLUSTER_NAME \
               --region $AWS_REGION
      # 4. Create monitoring namespace
      - name: Create monitoring namespace
        run: |
          kubectl apply -f monitoring/namespace.yaml
      # 5. Install Helm
      - name: Install Helm
        uses: azure/setup-helm@v4
      # 6. Add Prometheus Helm repository
      - name: Add Helm repo
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
      # 7. Deploy kube-prometheus-stack
      - name: Deploy monitoring stack
        run: |
          helm upgrade --install kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --values monitoring/values.yaml
          
